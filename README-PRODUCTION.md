# üöÄ Production Deployment Guide - Disposable Browser Service

This guide will help you deploy a production-grade disposable browser service using SWAG (Secure Web Application Gateway) with automatic SSL certificates, proper WebSocket support, and session management.

## üéØ What This Solves

- ‚úÖ **SSL/TLS Encryption** - Automatic Let's Encrypt certificates
- ‚úÖ **WebSocket Support** - Proper VNC streaming without browser errors
- ‚úÖ **Session Management** - Redis-based persistent session storage
- ‚úÖ **Automatic Cleanup** - Expired sessions are automatically removed
- ‚úÖ **Production Security** - Reverse proxy with proper headers
- ‚úÖ **Monitoring** - Comprehensive logging and health checks

## üìã Prerequisites

1. **Domain Name** - A domain pointing to your server (e.g., `albizblog.online`)
2. **Server Access** - SSH access to your server
3. **Docker & Docker Compose** - Installed and running
4. **Port Access** - Ports 80 and 443 must be open and forwarded to your server

## üèóÔ∏è Architecture Overview

```
Internet ‚Üí SWAG (443/80) ‚Üí Backend API (5000) ‚Üí Chromium Containers (3000/3001)
                ‚Üì
            SSL Termination
            WebSocket Support
            Authentication
            Rate Limiting
```

## üöÄ Quick Deployment

### 1. Prerequisites

The deployment script will automatically:
- ‚úÖ Set up Cloudflare DNS validation with your API token
- ‚úÖ Configure SWAG with your domain and email
- ‚úÖ Create all necessary directories and files

### 2. Deploy the Service

```bash
# Navigate to your project directory
cd /path/to/your/project

# Make the deployment script executable
chmod +x browser/deploy-production.sh

# Run the deployment script
./browser/deploy-production.sh
```

### 2. Manual Deployment (Alternative)

If you prefer manual deployment:

```bash
# Create necessary directories
mkdir -p browser/swag/config
mkdir -p browser/logs
mkdir -p browser/data/redis

# Create SWAG network
docker network create swag_network

# Deploy with Docker Compose V2
cd browser
docker compose -f docker-compose.production.yml up -d --build
```

## üîß Configuration

### Environment Variables

The deployment script creates a `.env` file with these settings:

```env
# Production Environment Variables
NODE_ENV=production
JWT_SECRET=<auto-generated>
CHROMIUM_IMAGE=lscr.io/linuxserver/chromium:latest
PUBLIC_HOST=browser.albizblog.online
REDIS_URL=redis://redis:6379
SESSION_TIMEOUT=300
EXTEND_DURATION=300
CLEANUP_INTERVAL=60000

# SWAG Configuration
URL=albizblog.online
SUBDOMAINS=wildcard
VALIDATION=dns
DNSPLUGIN=cloudflare
EMAIL=admin@albizblog.online
```

### Customizing the Domain

Edit the deployment script or manually update:

1. **Domain**: Change `DOMAIN="albizblog.online"` to your domain
2. **Subdomain**: Change `SUBDOMAIN="browser"` to your preferred subdomain
3. **DNS**: Ensure your domain has an A record pointing to your server IP

## üåê Accessing Your Service

After deployment, your service will be available at:

- **API Base**: `https://browser.albizblog.online/api/`
- **Health Check**: `https://browser.albizblog.online/api/health`
- **Token Generation**: `https://browser.albizblog.online/api/dev/token`

### API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/health` | GET | Health check (no auth) |
| `/api/dev/token` | GET | Generate test JWT token |
| `/api/browser/start` | POST | Start a new browser session |
| `/api/browser/stop` | POST | Stop a session |
| `/api/browser/extend` | POST | Extend session time |
| `/api/browser/remaining_time` | GET | Get remaining session time |

## üîê Authentication

All API endpoints (except health check) require a JWT token:

```bash
# Get a test token
curl https://browser.albizblog.online/api/dev/token

# Use the token
curl -H "Authorization: Bearer YOUR_TOKEN" \
     -X POST https://browser.albizblog.online/api/browser/start \
     -H "Content-Type: application/json" \
     -d '{"userId": "test-user"}'
```

## üñ•Ô∏è Browser Sessions

### Starting a Session

```bash
# 1. Get a token
TOKEN=$(curl -s https://browser.albizblog.online/api/dev/token | jq -r '.token')

# 2. Start a session
curl -X POST https://browser.albizblog.online/api/browser/start \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"userId": "my-user"}'
```

### Accessing the Browser

The response will include a `gui_url` that looks like:
```
https://browser.albizblog.online/session/CONTAINER_ID/
```

This URL will:
- ‚úÖ Work with HTTPS (no certificate warnings)
- ‚úÖ Support WebSocket connections (no audio/video errors)
- ‚úÖ Automatically proxy to the correct container
- ‚úÖ Handle session expiration gracefully

## üõ†Ô∏è Management Commands

### View Logs

```bash
# All services
docker compose -f docker-compose.production.yml logs -f

# Individual services
docker logs swag -f
docker logs browser-backend -f
docker logs browser-redis -f
docker logs browser-cleanup-worker -f
```

### Service Management

```bash
# Stop all services
docker compose -f docker-compose.production.yml down

# Restart services
docker compose -f docker-compose.production.yml restart

# Update services
docker compose -f docker-compose.production.yml pull
docker compose -f docker-compose.production.yml up -d

# View running containers
docker compose -f docker-compose.production.yml ps
```

### SWAG Management

```bash
# Check SSL certificate status
docker exec swag cat /config/log/letsencrypt/letsencrypt.log

# Reload SWAG configuration
docker exec swag nginx -s reload

# Check SWAG configuration
docker exec swag nginx -t
```

## üîç Troubleshooting

### SSL Certificate Issues

If SSL certificates aren't generating:

1. **Check DNS**: Ensure your domain points to your server
2. **Check Ports**: Ensure ports 80 and 443 are open
3. **Check SWAG Logs**: `docker logs swag -f`
4. **Manual Validation**: Try HTTP validation instead of DNS

### Browser Connection Issues

If the browser GUI is blank or shows errors:

1. **Check WebSocket**: Ensure the proxy configuration includes WebSocket headers
2. **Check Container**: Verify the Chromium container is running
3. **Check Logs**: Look for proxy errors in SWAG logs
4. **Try Incognito**: Use incognito mode to bypass HSTS

### Session Management Issues

If sessions aren't working properly:

1. **Check Redis**: `docker logs browser-redis`
2. **Check Cleanup Worker**: `docker logs browser-cleanup-worker`
3. **Check Backend**: `docker logs browser-backend`

### Common Error Messages

| Error | Solution |
|-------|----------|
| `AudioDecoderWorker not ready` | ‚úÖ Fixed by HTTPS + WebSocket proxy |
| `Cannot read properties of undefined` | ‚úÖ Fixed by HTTPS + WebSocket proxy |
| `Session not found` | Check Redis connection and session storage |
| `Container creation timeout` | Check Docker daemon and image availability |

## üîí Security Considerations

### Production Security

1. **Change Default JWT Secret**: The deployment script generates a random secret
2. **Add Authentication**: Consider adding user authentication before the API
3. **Rate Limiting**: SWAG can be configured with rate limiting
4. **Firewall**: Ensure only necessary ports are open
5. **Regular Updates**: Keep Docker images updated

### SWAG Security Features

- ‚úÖ Automatic SSL certificate renewal
- ‚úÖ Security headers (HSTS, CSP, etc.)
- ‚úÖ Rate limiting (if configured)
- ‚úÖ Fail2ban integration (if configured)
- ‚úÖ Geo-blocking (if configured)

## üìä Monitoring

### Health Checks

```bash
# API Health
curl https://browser.albizblog.online/api/health

# Redis Health
docker exec browser-redis redis-cli ping

# Container Status
docker compose -f docker-compose.production.yml ps
```

### Metrics to Monitor

- Active sessions count
- Session duration
- Container creation/cleanup rates
- API response times
- SSL certificate status
- Redis memory usage

## üîÑ Updates and Maintenance

### Updating Services

```bash
# Pull latest images
docker compose -f docker-compose.production.yml pull

# Restart with new images
docker compose -f docker-compose.production.yml up -d

# Check for any issues
docker compose -f docker-compose.production.yml logs -f
```

### Backup

```bash
# Backup Redis data
docker exec browser-redis redis-cli BGSAVE

# Backup SWAG configuration
tar -czf swag-backup-$(date +%Y%m%d).tar.gz swag/config/
```

## üéâ Success Indicators

Your deployment is successful when:

1. ‚úÖ `https://browser.albizblog.online/api/health` returns `{"status":"ok"}`
2. ‚úÖ You can create a session and access the browser GUI
3. ‚úÖ The browser GUI loads without audio/video errors
4. ‚úÖ Sessions automatically expire after 5 minutes
5. ‚úÖ SSL certificate shows as valid in browser

## üìû Support

If you encounter issues:

1. Check the logs: `docker compose -f docker-compose.production.yml logs -f`
2. Verify DNS settings point to your server
3. Ensure ports 80 and 443 are open and forwarded
4. Check SWAG documentation: https://docs.linuxserver.io/general/swag/

---

**üéØ This setup provides a production-grade, secure, and scalable disposable browser service with automatic SSL, proper WebSocket support, and comprehensive session management.** 